<!DOCTYPE html>
<html>
	<head>
		<title>TODO supply a title</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

		<script type="text/javascript" src="build/jsbox2d.js"></script>

		<script type="text/javascript" src="CanvasDebug.js"></script>

		<script type="text/javascript" src="Test.js"></script>
		<script type="text/javascript" src="TestPyramid.js"></script>
		<script type="text/javascript" src="TestEdge.js"></script>
		<script type="text/javascript" src="TestSphereStack.js"></script>
		<script type="text/javascript" src="TestConveyorBelt.js"></script>
		<script type="text/javascript" src="TestContinuous.js"></script>
		<script type="text/javascript" src="TestVaryingRestitution.js"></script>
		<script type="text/javascript" src="TestVaryingFriction.js"></script>
		<script type="text/javascript" src="TestAddPair.js"></script>
		<script type="text/javascript" src="TestTiles.js"></script>
		<script type="text/javascript" src="TestTumbler.js"></script>
		<script type="text/javascript" src="TestBridge.js"></script>
		<script type="text/javascript" src="TestChain.js"></script>
		<script type="text/javascript" src="TestRevolute.js"></script>
		<script type="text/javascript" src="TestTheoJansenWalker.js"></script>
		<script type="text/javascript" src="TestSliderCrank.js"></script>
		<script type="text/javascript" src="TestConfined.js"></script>
		<script type="text/javascript" src="TestPinball.js"></script>
		<script type="text/javascript" src="TestBullet.js"></script>
		<script type="text/javascript" src="TestCharacterCollision.js"></script>
		<script type="text/javascript" src="TestCollisionFiltering.js"></script>
		<script type="text/javascript" src="TestCollisionProcessing.js"></script>
		<script type="text/javascript" src="TestCompoundShapes.js"></script>
		<script type="text/javascript" src="TestSensor.js"></script>
		<script type="text/javascript" src="TestDominos.js"></script>
		<script type="text/javascript" src="TestApplyForce.js"></script>
		<script type="text/javascript" src="TestWeb.js"></script>
		<script type="text/javascript" src="TestBodyTypes.js"></script>
		<script type="text/javascript" src="TestBreakable.js"></script>
		<script type="text/javascript" src="TestConvexHull.js"></script>
		<script type="text/javascript" src="TestCantilever.js"></script>
		<script type="text/javascript" src="TestCar.js"></script>
		<script type="text/javascript" src="TestDistance.js"></script>
		<script type="text/javascript" src="TestEdgeShapes.js"></script>
		<script type="text/javascript" src="TestGears.js"></script>
		<script type="text/javascript" src="TestMobile.js"></script>
		<script type="text/javascript" src="TestMobileBalanced.js"></script>
		<script type="text/javascript" src="TestMotorJoint.js"></script>
		<script type="text/javascript" src="TestOneSidedPlatform.js"></script>
		<script type="text/javascript" src="TestPolyCollision.js"></script>
		<script type="text/javascript" src="TestPolyShapes.js"></script>
		<script type="text/javascript" src="TestPrismatic.js"></script>
		<script type="text/javascript" src="TestPulleys.js"></script>
		<script type="text/javascript" src="TestRayCast.js"></script>
		<script type="text/javascript" src="TestRope.js"></script>
		<script type="text/javascript" src="TestRopeJoint.js"></script>
		<script type="text/javascript" src="TestShapeEditing.js"></script>
		<script type="text/javascript" src="TestVerticalStack.js"></script>
		<script type="text/javascript" src="TestRUBE.js"></script>

		<style>
		/* FLEX STUFF */
		.flex.container
		{
			display: flex;
			display: -ms-flex;
			display: -moz-flex;
			display: -webkit-flex;
		}

		.flex.column
		{
			flex-direction: column;
			-ms-flex-direction: column;
			-moz-flex-direction: column;
			-webkit-flex-direction: column;
		}

		.flex.columnReverse
		{
			flex-direction: column-reverse;
			-ms-flex-direction: column-reverse;
			-moz-flex-direction: column-reverse;
			-webkit-flex-direction: column-reverse;
		}

		.flex.row
		{
			flex-direction: row;
			-ms-flex-direction: row;
			-moz-flex-direction: row;
			-webkit-flex-direction: row;
		}

		.flex.anchor
		{
			flex: 0 0 auto;
			-ms-flex: 0 0 auto;
			-moz-flex: 0 0 auto;
			-webkit-flex: 0 0 auto;
		}

		.flex.fillRest
		{
			flex: 0 1 auto;
			-ms-flex: 0 1 auto;
			-moz-flex: 0 1 auto;
			-webkit-flex: 0 1 auto;

			min-height: 0;
			min-width: 0;
		}

		.flex.fillRestGrow
		{
			flex: 1 1 auto;
			-ms-flex: 1 1 auto;
			-moz-flex: 1 1 auto;
			-webkit-flex: 1 1 auto;

			min-height: 0;
			min-width: 0;
		}

		.flex.allBasis
		{
			flex-basis: 100%;
			-ms-flex-basis: 100%;
			-moz-flex-basis: 100%;
			-webkit-flex-basis: 100%;
		}

		.flex.noShrink
		{
			flex-shrink: 0;
			-ms-flex-shrink: 0;
			-moz-flex-shrink: 0;
			-webkit-flex-shrink: 0;
		}

		.flex.centerAll
		{
			align-items: center;
			-ms-align-items: center;
			-moz-align-items: center;
			-webkit-align-items: center;

			justify-content: center;
			-ms-justify-content: center;
			-moz-justify-content: center;
			-webkit-justify-content: center;
		}

		.flex.centerAlign
		{
			align-items: center;
			-ms-align-items: center;
			-moz-align-items: center;
			-webkit-align-items: center;
		}

		.flex.centerJustify
		{
			justify-content: center;
			-ms-justify-content: center;
			-moz-justify-content: center;
			-webkit-justify-content: center;
		}

		html, body
		{
			margin: 0;
			width: 100%;
			height: 100%;
		}
		</style>
	</head>
	<body>
		<div class="flex container" style="width: 100%; height: 100%;">
			<div class="flex container fillRestGrow">
				<canvas style="background: #333333;" class="flex fillRestGrow" id="canvas"></canvas>
				<div id='debugText' style="color: white; position: absolute; left: 0; top: 0;">DEBUG</div>
			</div>
			<div class="flex anchor container column" style="width: 240px;">
				<label for="test">Test</label>
				<select id="test"></select>
				<hr style="width: 100%;"/>
				<label id="label_velIters" for="velIters">Velocity Iterations (<span class="val">8</span>)</label>
				<input id="velIters" type="range" min="0" max="50" value="8"></input>
				<label id="label_posIters" for="posIters">Position Iterations (<span class="val">3</span>)</label>
				<input id="posIters" type="range" min="0" max="50" value="3"></input>
				<label id="label_hertz" for="hertz">Hertz (<span class="val">60</span>)</label>
				<input id="hertz" type="range" min="2" max="120" value="60"></input>
				<hr style="width: 100%;"/>
				<div>
					<input id="allowSleep" type="checkbox" checked="checked"></input>
					<label for="allowSleep">Allow Sleep</label>
				</div>
				<div>
					<input id="warmStarting" type="checkbox" checked="checked"></input>
					<label for="warmStarting">Warm Starting</label>
				</div>
				<div>
					<input id="toi" type="checkbox" checked="checked"></input>
					<label for="toi">Time of Impact</label>
				</div>
				<div>
					<input id="substep" type="checkbox"></input>
					<label for="substep">Substepping</label>
				</div>
				<hr style="width: 100%;"/>
				<div>
					<input id="drawShapes" type="checkbox" checked="checked"></input>
					<label for="drawShapes">Shapes</label>
				</div>
				<div>
					<input id="drawJoints" type="checkbox" checked="checked"></input>
					<label for="drawJoints">Joints</label>
				</div>
				<div>
					<input id="drawAABBs" type="checkbox"></input>
					<label for="drawAABBs">AABBs</label>
				</div>
				<div>
					<input id="drawContactPoints" type="checkbox"></input>
					<label for="drawContactPoints">Contact Points</label>
				</div>
				<div>
					<input id="drawContactNormals" type="checkbox"></input>
					<label for="drawContactNormals">Contact Normals</label>
				</div>
				<div>
					<input id="drawContactImpulses" type="checkbox"></input>
					<label for="drawContactImpulses">Contact Impulses</label>
				</div>
				<div>
					<input id="drawFrictionImpulses" type="checkbox"></input>
					<label for="drawFrictionImpulses">Friction Impulses</label>
				</div>
				<div>
					<input id="drawCenters" type="checkbox"></input>
					<label for="drawCenters">Center of Masses</label>
				</div>
				<div>
					<input id="drawStatistics" type="checkbox"></input>
					<label for="drawStatistics">Statistics</label>
				</div>
				<div>
					<input id="drawProfile" type="checkbox"></input>
					<label for="drawProfile">Profile</label>
				</div>
				<hr style="width: 100%;"/>
				<button id="pause">Pause (P)</button>
				<button id="step">Step (L)</button>
				<button id="restart">Restart (R)</button>
			</div>
		</div>

		<script>
			"use strict";

		// Fix Function#name on browsers that do not support it (IE):
		if (typeof((function f() {}).name) === 'undefined') {
			Object.defineProperty(Function.prototype, 'name', {
				get: function() {
					var name = this.toString().match(/^\s*function\s*(\w*)\s*\(/)[1];
					// For better performance only parse once, and then cache the
					// result through a new accessor for repeated access.
					Object.defineProperty(this, 'name', { value: name });
					return name;
				}
			});
		}

			var canvas = document.getElementById('canvas');
			var cQ = $(canvas);

			canvas.width = canvas.clientWidth;
			canvas.height = canvas.clientHeight;

			var context = canvas.getContext('2d');

			var tests =
				[
					TestPyramid,
					TestEdge,
					TestSphereStack,
					TestConveyorBelt,
					TestVaryingRestitution,
					TestVaryingFriction,
					TestContinuous,
					TestAddPair,
					TestTiles,
					TestTumbler,
					TestBridge,
					TestChain,
					TestRevolute,
					TestTheoJansenWalker,
					TestSliderCrank,
					TestConfined,
					TestPinball,
					TestBullet,
					TestCharacterCollision,
					TestCollisionFiltering,
					TestCollisionProcessing,
					TestCompoundShapes,
					TestSensor,
					TestDominos,
					TestApplyForce,
					TestWeb,
					TestBodyTypes,
					TestBreakable,
					TestConvexHull,
					TestCantilever,
					TestCar,
					TestDistance,
					TestEdgeShapes,
					TestGears,
					TestMobile,
					TestMobileBalanced,
					TestMotorJoint,
					TestOneSidedPlatform,
					TestPolyCollision,
					TestPolyShapes,
					TestPrismatic,
					TestPulleys,
					TestRayCast,
					TestRope,
					TestRopeJoint,
					TestShapeEditing,
					TestVerticalStack,
					TestRUBE
				];

			tests.sort(function(a, b)
			{
				return a.name.localeCompare(b.name);
			});

			var testSelect = $('#test');

			for (var i = 0; i < tests.length; ++i)
				testSelect.append('<option>' + tests[i].name.substr(4) + '</option>');

			testSelect[0].selectedIndex = 4;
			var currentTest = null;

			var debugDraw = new CanvasDebugDraw();
			debugDraw.context = context;
			debugDraw.SetFlags(b2Draw.e_shapeBit | b2Draw.e_jointBit);
			var dbg = $('#debugText');

			var drawLine = function(string)
			{
				dbg.html(dbg.html() + string + '<br/>');
			};

			testSelect.change(function()
			{
				var index = testSelect.prop("selectedIndex");
				var test = tests[index];

				var wasPaused = currentTest ? currentTest.m_pause : false;

				currentTest = new test();
				currentTest.m_debugDraw = debugDraw;
				currentTest.m_world.SetDebugDraw(debugDraw);
				currentTest.m_drawStringFunc = drawLine;
				currentTest.Initialize();

				currentTest.m_hz = 1 / $('#hertz').val();
				currentTest.m_hz_raw = $('#hertz').val();
				currentTest.m_velIters = $('#velIters').val();
				currentTest.m_posIters = $('#posIters').val();
				currentTest.m_world.SetAllowSleeping($('#allowSleep').is(':checked'));
				currentTest.m_world.SetWarmStarting($('#warmStarting').is(':checked'));
				currentTest.m_world.SetContinuousPhysics($('#toi').is(':checked'));
				currentTest.m_world.SetSubStepping($('#substep').is(':checked'));

				currentTest.m_pause = wasPaused;
			});

			$('#hertz').change(function()
			{
				currentTest.m_hz = 1 / $('#hertz').val();
				currentTest.m_hz_raw = $('#hertz').val();
				$('#label_hertz').find('.val').text($('#hertz').val());
			});

			$('#velIters').change(function()
			{
				currentTest.m_velIters = $('#velIters').val();
				$('#label_velIters').find('.val').text($('#velIters').val());
			});

			$('#posIters').change(function()
			{
				currentTest.m_posIters = $('#posIters').val();
				$('#label_posIters').find('.val').text($('#posIters').val());
			});


			$('#allowSleep').click(function()
			{
				currentTest.m_world.SetAllowSleeping($('#allowSleep').is(':checked'));
			});

			$('#warmStarting').click(function()
			{
				currentTest.m_world.SetWarmStarting($('#warmStarting').is(':checked'));
			});

			$('#toi').click(function()
			{
				currentTest.m_world.SetContinuousPhysics($('#toi').is(':checked'));
			});

			$('#substep').click(function()
			{
				currentTest.m_world.SetSubStepping($('#substep').is(':checked'));
			});


			$('#drawShapes').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_shapeBit);
			});

			$('#drawJoints').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_jointBit);
			});

			$('#drawAABBs').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_aabbBit);
			});

			$('#drawCenters').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_centerOfMassBit);
			});

			$('#drawContactPoints').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_contactPoints);
			});

			$('#drawContactNormals').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_contactNormals);
			});

			$('#drawContactImpulses').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_contactImpulses);
			});

			$('#drawFrictionImpulses').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_frictionImpulses);
			});

			$('#drawStatistics').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_statistics);
			});

			$('#drawProfile').click(function()
			{
				debugDraw.ToggleFlags(b2Draw.e_profile);
			});


			$('#pause').click(function()
			{
				currentTest.m_pause = !currentTest.m_pause;
			});

			$('#step').click(function()
			{
				currentTest.m_pause = true;
				currentTest.m_singleStep = true;
			});

			$('#restart').click(function()
			{
				testSelect.change();
			});

			var m_clickPos;

			cQ.attr("tabindex", 0);

			cQ.mousedown(function(e)
			{
				var x = e.clientX;
				var y = canvas.height - e.clientY;

				x -= canvas.width / 2;
				y -= 128;

				x /= 14;
				y /= 14;

				if (e.which === 1)
					currentTest.MouseDown(new b2Vec2(x, y));
				else if (e.which === 3)
					m_clickPos = [x, y];

				cQ.focus();

				e.preventDefault();
				return false;
			});

			cQ.mouseup(function(e)
			{
				var x = e.clientX;
				var y = canvas.height - e.clientY;

				x -= canvas.width / 2;
				y -= 128;

				x /= 14;
				y /= 14;

				if (e.which === 1)
					currentTest.MouseUp(new b2Vec2(x, y));

				e.preventDefault();
				return false;
			});

			cQ.mousemove(function(e)
			{
				var x = e.clientX;
				var y = canvas.height - e.clientY;

				x -= canvas.width / 2;
				y -= 128;

				x /= 14;
				y /= 14;

				if (e.which === 1)
					currentTest.MouseMove(new b2Vec2(x, y));
				else if (e.which === 3)
				{
					var diff = [x - m_clickPos[0], y - m_clickPos[1]];

					currentTest.m_center.x -= diff[0];
					currentTest.m_center.y -= diff[1];

					m_clickPos = [x, y];
				}

				e.preventDefault();
				return false;
			});

			$(document).keydown(function(e)
			{
				if (e.keyCode === 'R'.charCodeAt())
					testSelect.change();
				else
					currentTest.Keyboard(e.keyCode);
			});

			$(document).keyup(function(e)
			{
				currentTest.KeyboardUp(e.keyCode);
			});

			testSelect.change();

			window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

			// This is our little game loop.
			function step()
			{
				dbg.text("");
				context.save();
				context.clearRect(0, 0, canvas.width, canvas.height);

				currentTest.Step();
				context.restore();

				window.requestAnimationFrame(step);
			}

			window.requestAnimationFrame(step);
		</script>
	</body>
</html>
